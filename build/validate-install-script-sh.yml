parameters:
- name: repo
  type: string

jobs:
- job: validateLineEndings
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: |
      if grep $'\r' ./helpers/installcredprovider.sh; then 
        echo "CRLF line ending found"
        exit 1
      fi
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallDefault
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net6.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi
      
      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallNet8
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      export USE_NET6_ARTIFACTS_CREDENTIAL_PROVIDER=false
      export USE_NET8_ARTIFACTS_CREDENTIAL_PROVIDER=true
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net8.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi

      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallNet8linux-x64
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      export USE_NET6_ARTIFACTS_CREDENTIAL_PROVIDER=false
      export USE_NET8_ARTIFACTS_CREDENTIAL_PROVIDER=true
      export ARTIFACTS_CREDENTIAL_PROVIDER_RID=linux-x64
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net8.linux-x64.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi

      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallNet8linux-arm64
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      export USE_NET6_ARTIFACTS_CREDENTIAL_PROVIDER=false
      export USE_NET8_ARTIFACTS_CREDENTIAL_PROVIDER=true
      export ARTIFACTS_CREDENTIAL_PROVIDER_RID=linux-arm64
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net8.linux-arm64.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi

      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallNet8osx-arm64
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      export USE_NET6_ARTIFACTS_CREDENTIAL_PROVIDER=false
      export USE_NET8_ARTIFACTS_CREDENTIAL_PROVIDER=true
      export ARTIFACTS_CREDENTIAL_PROVIDER_RID=osx-arm64
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net8.osx-arm64.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi

      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script
- job: LinuxInstallNet8osx-x64
  steps:
  - checkout: ${{ parameters.repo }}
  - bash: | 
      export USE_NET6_ARTIFACTS_CREDENTIAL_PROVIDER=false
      export USE_NET8_ARTIFACTS_CREDENTIAL_PROVIDER=true
      export ARTIFACTS_CREDENTIAL_PROVIDER_RID=osx-x64
      ./helpers/installcredprovider.sh -Force >> ./output.log
      cat ./output.log

      if ! grep "Microsoft.Net8.osx-x64.NuGet.CredentialProvider" ./output.log; then
        echo "Expected credential provider not found"
        exit 1
      fi
      if [ ! -d "$HOME/.nuget/plugins/netcore/CredentialProvider.Microsoft" ]; then
        echo "Credential provider plugin directory not found"
        exit 1
      fi

      echo "Credential provider installed successfully"
    workingDirectory: $(Build.SourcesDirectory)
    displayName: Validate Install Script